name: Daily Brand Sync

on:
  # Runs every day at 3 AM UTC
  schedule:
    - cron: '0 3 * * *'

  # Also lets you trigger it manually from GitHub.com
  workflow_dispatch:
    inputs:
      max_pages:
        description: 'Max pages to fetch (leave empty for all)'
        required: false
        default: ''

jobs:
  sync:
    name: Sync brands from Shoptastic API
    runs-on: ubuntu-latest
    timeout-minutes: 360   # 6-hour cap (GitHub maximum)

    steps:
      # ── 1. Checkout repo ──────────────────────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # Fetch full history so we can commit back
          fetch-depth: 0

      # ── 2. Setup Node ─────────────────────────────────────────────────────
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ── 3. Install dependencies ──────────────────────────────────────────
      - name: Install dependencies
        run: npm ci

      # ── 4. Run sync script ───────────────────────────────────────────────
      # PAGE_DELAY_MS = 900000 = 15 minutes between pages → 4 calls/hour
      # MAX_PAGES limits how many pages we fetch per run to stay within
      # GitHub's 6-hour timeout. With 15-min delays, we can do ~24 pages
      # per run. Set to 20 to stay safe. Full data builds up over ~4 days.
      - name: Run brand sync
        env:
          PAGE_DELAY_MS: '900000'
          MAX_PAGES: ${{ github.event.inputs.max_pages || '20' }}
        run: npm run sync:resume

      # ── 5. Commit updated JSON files ─────────────────────────────────────
      - name: Commit brand data
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Stage only the generated data files (not .sync-checkpoint.json)
          git add \
            data/brands-us.json data/brands-uk.json data/brands-de.json data/brands-fr.json \
            data/brands-nl.json data/brands-es.json data/brands-it.json data/brands-se.json \
            data/brands-ch.json data/brands-at.json data/brands-au.json data/brands-dk.json \
            data/brands-ca.json data/brands-fi.json data/brands-mx.json data/brands-br.json \
            data/brands-be.json data/brands-no.json \
            data/categories-us.json data/categories-uk.json data/categories-de.json data/categories-fr.json \
            data/categories-nl.json data/categories-es.json data/categories-it.json data/categories-se.json \
            data/categories-ch.json data/categories-at.json data/categories-au.json data/categories-dk.json \
            data/categories-ca.json data/categories-fi.json data/categories-mx.json data/categories-br.json \
            data/categories-be.json data/categories-no.json \
            data/search-index-us.json data/search-index-uk.json data/search-index-de.json data/search-index-fr.json \
            data/search-index-nl.json data/search-index-es.json data/search-index-it.json data/search-index-se.json \
            data/search-index-ch.json data/search-index-at.json data/search-index-au.json data/search-index-dk.json \
            data/search-index-ca.json data/search-index-fi.json data/search-index-mx.json data/search-index-br.json \
            data/search-index-be.json data/search-index-no.json \
            data/top-brands-matched-us.json data/top-brands-matched-uk.json \
            data/top-brands-matched-de.json data/top-brands-matched-fr.json \
            data/sync-summary.json || true

          # Only commit if there are actual changes
          if git diff --staged --quiet; then
            echo "No changes to commit — data is up to date."
          else
            BRAND_COUNT=$(node -e "
              const s = require('./data/sync-summary.json');
              console.log(s.total + ' brands (' + Object.entries(s.markets).map(([k,v]) => k+':'+v).join(', ') + ')');
            ")
            git commit -m "chore: sync brand data — ${BRAND_COUNT}

Auto-generated by GitHub Actions at $(date -u '+%Y-%m-%d %H:%M UTC')"
            git push
          fi
